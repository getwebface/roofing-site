// Cloudflare Worker â€” Universal Template Router with Edge-Side Rendering
// Env vars required:
//   SHEETS_API   e.g. https://script.google.com/macros/s/XXXX/exec
//   API_KEY      shared secret (or leave empty if your Apps Script doesn't require it)
//   ASSET_ORIGIN e.g. https://your-static-site.example.com   (NO trailing slash)
//
// Env vars optional:
//   DEFAULT_TEMPLATE  default "/index.html"
//
// Routes:
//   /                      -> {pageType:"home",   slug:"home"}     uses DEFAULT_TEMPLATE
//   /services/<slug>       -> {pageType:"auto",   slug:<slug>}     uses DEFAULT_TEMPLATE
//   /areas/<slug>          -> {pageType:"auto",   slug:<slug>}     uses DEFAULT_TEMPLATE
//
// Debug:
//   Add ?debug=1 to any page request to get JSON explaining what failed.
//   Example: /services/leak-repair?debug=1
//
// Telemetry:
//   Browser posts to /t  (Worker forwards to Apps Script with key server-side)
//   This avoids Apps Script CORS/preflight issues.

export default {
  async fetch(request, env) {
    const url = new URL(request.url);
    const debug = url.searchParams.get("debug") === "1";

    const SHEETS_API = env.SHEETS_API;
    const API_KEY = env.API_KEY || "";
    const ASSET_ORIGIN = (env.ASSET_ORIGIN || "").replace(/\/+$/, "");

    const DEFAULT_TEMPLATE = env.DEFAULT_TEMPLATE || "/index.html";

    if (!SHEETS_API || !ASSET_ORIGIN) {
      return new Response(
        "Missing env vars: SHEETS_API and/or ASSET_ORIGIN",
        { status: 500 }
      );
    }

    // ---- OPTIONS (CORS) ----
    if (request.method === "OPTIONS") {
      return new Response(null, { status: 204, headers: corsHeaders(request) });
    }

    // ---- Telemetry proxy ----
    if (url.pathname === "/t") {
      if (request.method !== "POST") {
        return new Response("Method Not Allowed", {
          status: 405,
          headers: corsHeaders(request),
        });
      }

      const forwardURL = new URL(SHEETS_API);
      if (API_KEY) forwardURL.searchParams.set("key", API_KEY);

      const bodyText = await request.text();

      let forwardRes;
      try {
        forwardRes = await fetch(forwardURL.toString(), {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: bodyText,
          cf: { cacheTtl: 0, cacheEverything: false },
        });
      } catch (err) {
        return debugJson(
          debug,
          502,
          { where: "telemetry_fetch", error: String(err), forwardURL: forwardURL.toString() },
          "Bad Gateway"
        );
      }

      const outText = await forwardRes.text();
      return new Response(outText, {
        status: forwardRes.status,
        headers: {
          "content-type": forwardRes.headers.get("content-type") || "application/json",
          "cache-control": "no-store",
          ...corsHeaders(request),
        },
      });
    }

    // ---- Static asset passthrough ----
    // If it looks like a file, pull it from ASSET_ORIGIN.
    if (/\.[a-zA-Z0-9]{2,6}$/.test(url.pathname)) {
      return fetch(`${ASSET_ORIGIN}${url.pathname}`, request);
    }

    // ---- SIMPLIFIED ROUTING LOGIC ----
    let slug = normalizeSlug(url.pathname === "/" || url.pathname === "" ? "home" : lastSegment(url.pathname));
    let pageType = "auto"; // Let Apps Script determine if it's a service/local page
    let templatePath = DEFAULT_TEMPLATE; // Forces usage of the Universal Template (index.html)

    // ---- Fetch template (force GET) ----
    const templateURL = `${ASSET_ORIGIN}${templatePath}`;
    let templateRes;
    try {
      templateRes = await fetch(new Request(templateURL, { method: "GET" }));
    } catch (err) {
      return debugJson(
        debug,
        502,
        {
          where: "template_fetch",
          error: String(err),
          templateURL,
          ASSET_ORIGIN,
          templatePath,
          pageType,
          slug,
        },
        "Bad Gateway"
      );
    }

    if (!templateRes.ok) {
      return debugJson(
        debug,
        404,
        {
          where: "template_status",
          templateStatus: templateRes.status,
          templateURL,
          ASSET_ORIGIN,
          templatePath,
          pageType,
          slug,
        },
        `Template not found: ${templateURL}`
      );
    }

    // ---- Fetch data from Apps Script ----
    const dataURL = new URL(SHEETS_API);
    if (API_KEY) dataURL.searchParams.set("key", API_KEY);
    dataURL.searchParams.set("slug", slug);
    dataURL.searchParams.set("pageType", pageType);

    let dataRes;
    try {
      dataRes = await fetch(dataURL.toString(), {
        method: "GET",
        cf: { cacheTtl: 0, cacheEverything: false },
      });
    } catch (err) {
      return debugJson(
        debug,
        502,
        { where: "data_fetch", error: String(err), dataURL: dataURL.toString(), pageType, slug },
        "Bad Gateway"
      );
    }

    let sheetData = {};
    const ct = dataRes.headers.get("content-type") || "";

    if (dataRes.ok && ct.includes("application/json")) {
      try {
        sheetData = await dataRes.json();
      } catch (err) {
        sheetData = {};
      }
    } else if (debug) {
      // If debug=1, capture a little of the body even if it's not JSON
      let bodyPreview = "";
      try {
        const t = await dataRes.text();
        bodyPreview = t.slice(0, 600);
      } catch {}
      return debugJson(
        true,
        502,
        {
          where: "data_non_json_or_error",
          dataStatus: dataRes.status,
          contentType: ct,
          dataURL: dataURL.toString(),
          bodyPreview,
          pageType,
          slug,
        },
        "Upstream data error"
      );
    }

    // ---- Not found if data says doesn't exist (except home) ----
    if (!sheetData?.exists && slug !== "home") {
      return debugJson(
        debug,
        404,
        {
          where: "data_not_found",
          dataURL: dataURL.toString(),
          dataStatus: dataRes.status,
          contentType: ct,
          sheetData,
          pageType,
          slug,
        },
        "Not found"
      );
    }

    // ---- HTML rewrite (enhanced with section visibility matrix) ----
    const rewriter = new HTMLRewriter();
    const actualPageType = sheetData?.actualPageType || sheetData?.pageType || "home";

    // 1. METADATA INJECTION
    rewriter.on('title[data-slot="meta_title"]', {
      element(el) {
        const title = sheetData?.copy?.headline || "Melbourne Roof Repairs";
        el.setInnerContent(title, { html: false });
      }
    });

    rewriter.on('meta[name="description"]', {
      element(el) {
        const desc = sheetData?.copy?.service_description || sheetData?.copy?.area_description || sheetData?.copy?.body || "";
        el.setAttribute("content", desc.substring(0, 160));
      }
    });

    rewriter.on('meta[property="og:title"]', {
      element(el) {
        const title = sheetData?.copy?.headline || "Melbourne Roof Repairs";
        el.setAttribute("content", title);
      }
    });

    rewriter.on('meta[property="og:description"]', {
      element(el) {
        const desc = sheetData?.copy?.service_description || sheetData?.copy?.area_description || sheetData?.copy?.body || "";
        el.setAttribute("content", desc.substring(0, 160));
      }
    });

    rewriter.on('meta[property="og:image"]', {
      element(el) {
        const image = sheetData?.copy?.og_image || "https://placehold.co/1200x630/007bff/ffffff?text=Melbourne+Roof+Repairs";
        el.setAttribute("content", image);
      }
    });

    // 2. SCHEMA GENERATION
    rewriter.on('script[data-slot="schema_json"]', {
      element(el) {
        const schema = generateSchema(sheetData);
        el.setInnerContent(JSON.stringify(schema, null, 2), { html: true });
      }
    });

    // 3. BREADCRUMBS
    rewriter.on('[data-slot="breadcrumbs"]', {
      element(el) {
        const breadcrumbs = generateBreadcrumbs(sheetData);
        el.setInnerContent(breadcrumbs, { html: true });
      }
    });

    // 4. SECTION VISIBILITY MATRIX
    if (actualPageType === 'service') {
      rewriter.on('[data-section="hero-service"]', { element(el) { el.setAttribute("style", "display: block;"); } });
      rewriter.on('#service-wrapper', { element(el) { el.setAttribute("style", "display: block;"); } });
    } else if (actualPageType === 'local') {
      rewriter.on('[data-section="hero-local"]', { element(el) { el.setAttribute("style", "display: block;"); } });
      rewriter.on('#local-wrapper', { element(el) { el.setAttribute("style", "display: block;"); } });
    } else {
      // Default to Home
      rewriter.on('[data-section="hero-home"]', { element(el) { el.setAttribute("style", "display: block;"); } });
      rewriter.on('#home-wrapper', { element(el) { el.setAttribute("style", "display: block;"); } });
    }

    // 5. STANDARD COPY SLOTS
    if (sheetData?.copy && typeof sheetData.copy === "object") {
      for (const [key, rawVal] of Object.entries(sheetData.copy)) {
        const value = rawVal == null ? "" : String(rawVal);
        rewriter.on(`[data-slot="${cssEscape(key)}"]`, {
          element(el) {
            const tag = (el.tagName || "").toLowerCase();
            const slotType = el.getAttribute("data-slot-type");

            if (tag === "img") {
              if (value) el.setAttribute("src", value);
            } else if (tag === "a") {
              if (value) el.setAttribute("href", value);
            } else if (slotType === "rich") {
              el.setInnerContent(value, { html: true });
            } else {
              el.setInnerContent(value, { html: false });
            }
          },
        });
      }
    }

    // 6. EMBED INITIAL DATA FOR CLIENT-SIDE A/B
    rewriter.on("head", {
      element(el) {
        const json = safeJsonForHtml(sheetData);
        el.append(
          `<script type="application/json" id="__INITIAL_DATA__">${json}</script>`,
          { html: true }
        );
      }
    });

    const out = rewriter.transform(templateRes);
    out.headers.set("content-type", "text/html; charset=utf-8");
    out.headers.set("cache-control", "no-store");
    out.headers.set("x-router", `${actualPageType}:${slug}:${templatePath}`);
    return out;
  },
};

// ---------- Schema Generation ----------
function generateSchema(sheetData) {
  const pageType = sheetData?.actualPageType || sheetData?.pageType || "home";
  const copy = sheetData?.copy || {};
  const slug = sheetData?.slug || "";

  if (pageType === 'service') {
    return {
      "@context": "https://schema.org",
      "@type": "Service",
      "name": copy.headline || "Roofing Service",
      "description": copy.service_description || copy.body || "",
      "provider": {
        "@type": "Organization",
        "name": "Melbourne Roof Repairs",
        "telephone": copy.phone_number || "0482022493"
      },
      "areaServed": {
        "@type": "City",
        "name": "Melbourne"
      }
    };
  } else if (pageType === 'local') {
    const areaServed = slug ? slug.charAt(0).toUpperCase() + slug.slice(1) : "Melbourne";
    
    return {
      "@context": "https://schema.org",
      "@type": "LocalBusiness",
      "name": copy.headline || "Local Roofing Service",
      "description": copy.area_description || copy.body || "",
      "address": {
        "@type": "PostalAddress",
        "addressLocality": areaServed,
        "addressRegion": "VIC",
        "addressCountry": "AU"
      },
      "telephone": copy.phone_number || "0482022493",
      "priceRange": "$$",
      "areaServed": {
        "@type": "City",
        "name": areaServed
      }
    };
  } else if (pageType === 'home') {
    return {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "Melbourne Roof Repairs",
      "description": copy.body || "",
      "url": "https://melbourneroofrepairs.com.au",
      "telephone": copy.phone_number || "0482022493",
      "priceRange": "$$"
    };
  } else {
    return {
      "@context": "https://schema.org",
      "@type": "WebPage",
      "name": copy.headline || "Melbourne Roof Repairs",
      "description": copy.body || ""
    };
  }
}

function generateBreadcrumbs(sheetData) {
  const pageType = sheetData?.actualPageType || sheetData?.pageType || "home";
  const slug = sheetData?.slug;

  if (pageType === 'service') {
    const serviceName = slug ? slug.replace(/-/g, ' ') : 'Service';
    return `<a href="/">Home</a> > <a href="/#services">Services</a> > <span data-slot="breadcrumb_current">${serviceName}</span>`;
  } else if (pageType === 'local') {
    const areaName = slug ? slug.charAt(0).toUpperCase() + slug.slice(1) : 'Area';
    return `<a href="/">Home</a> > <a href="/#areas">Service Areas</a> > <span data-slot="breadcrumb_current">${areaName}</span>`;
  } else {
    return `<a href="/">Home</a> > <span data-slot="breadcrumb_current">Current Page</span>`;
  }
}

// ---------- Helpers ----------
function debugJson(isDebug, status, obj, fallbackText) {
  if (!isDebug) return new Response(fallbackText || "Error", { status });
  return new Response(JSON.stringify(obj, null, 2), {
    status,
    headers: { "content-type": "application/json; charset=utf-8", "cache-control": "no-store" },
  });
}

function lastSegment(pathname) {
  const parts = pathname.split("/").filter(Boolean);
  const seg = parts.length ? parts[parts.length - 1] : "";
  return seg.replace(/\.html$/i, "");
}

function normalizeSlug(input) {
  return (
    String(input || "")
      .toLowerCase()
      .trim()
      .replace(/[^a-z0-9-]/g, "-")
      .replace(/-+/g, "-")
      .replace(/^-|-$/g, "") || "home"
  );
}

function cssEscape(str) {
  return String(str).replace(/["\\]/g, "\\$&");
}

function safeJsonForHtml(obj) {
  return JSON.stringify(obj ?? {})
    .replace(/</g, "\\u003c")
    .replace(/>/g, "\\u003e")
    .replace(/&/g, "\\u0026");
}

function corsHeaders(request) {
  const origin = request.headers.get("origin") || "*";
  return {
    "access-control-allow-origin": origin,
    "access-control-allow-methods": "GET,POST,OPTIONS",
    "access-control-allow-headers": "content-type",
    "access-control-max-age": "86400",
    vary: "Origin",
  };
}
